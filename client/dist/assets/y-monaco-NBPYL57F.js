import{c as E,a as x}from"./yjs--V61jkkQ.js";import{R as ct,S as N,a as at}from"./monaco-editor-TtZ-fpRa.js";const v=()=>new Map,ie=t=>{const e=v();return t.forEach((s,n)=>{e.set(n,s)}),e},lt=(t,e,s)=>{let n=t.get(e);return n===void 0&&t.set(e,n=s()),n},oe=(t,e)=>{const s=[];for(const[n,i]of t)s.push(e(i,n));return s},re=(t,e)=>{for(const[s,n]of t)if(e(n,s))return!0;return!1},ht=()=>new Set,ce=t=>t[t.length-1],ae=(t,e)=>{for(let s=0;s<e.length;s++)t.push(e[s])},ft=Array.from,ut=Array.isArray;class gt{constructor(){this._observers=v()}on(e,s){lt(this._observers,e,ht).add(s)}once(e,s){const n=(...i)=>{this.off(e,n),s(...i)};this.on(e,n)}off(e,s){const n=this._observers.get(e);n!==void 0&&(n.delete(s),n.size===0&&this._observers.delete(e))}emit(e,s){return ft((this._observers.get(e)||v()).values()).forEach(n=>n(...s))}destroy(){this._observers=v()}}const S=Math.floor,pt=Math.abs,le=Math.log10,dt=(t,e)=>t<e?t:e,K=(t,e)=>t>e?t:e,Q=t=>t!==0?t<0:1/t<0,he=1,fe=2,ue=4,ge=8,pe=32,Y=64,m=128,de=31,B=63,w=127,yt=2147483647,tt=Number.MAX_SAFE_INTEGER,bt=Number.isInteger||(t=>typeof t=="number"&&isFinite(t)&&S(t)===t),ye=String.fromCharCode,wt=t=>t.toLowerCase(),St=/^\s*/g,mt=t=>t.replace(St,""),At=/([A-Z])/g,be=(t,e)=>mt(t.replace(At,s=>`${e}${wt(s)}`)),Ut=t=>{const e=unescape(encodeURIComponent(t)),s=e.length,n=new Uint8Array(s);for(let i=0;i<s;i++)n[i]=e.codePointAt(i);return n},D=typeof TextEncoder<"u"?new TextEncoder:null,It=t=>D.encode(t),Dt=D?It:Ut;let U=typeof TextDecoder>"u"?null:new TextDecoder("utf-8",{fatal:!0,ignoreBOM:!0});U&&U.decode(new Uint8Array).length===1&&(U=null);class _{constructor(){this.cpos=0,this.cbuf=new Uint8Array(100),this.bufs=[]}}const _t=()=>new _,vt=t=>{let e=t.cpos;for(let s=0;s<t.bufs.length;s++)e+=t.bufs[s].length;return e},L=t=>{const e=new Uint8Array(vt(t));let s=0;for(let n=0;n<t.bufs.length;n++){const i=t.bufs[n];e.set(i,s),s+=i.length}return e.set(new Uint8Array(t.cbuf.buffer,0,t.cpos),s),e},Et=(t,e)=>{const s=t.cbuf.length;s-t.cpos<e&&(t.bufs.push(new Uint8Array(t.cbuf.buffer,0,t.cpos)),t.cbuf=new Uint8Array(K(s,e)*2),t.cpos=0)},h=(t,e)=>{const s=t.cbuf.length;t.cpos===s&&(t.bufs.push(t.cbuf),t.cbuf=new Uint8Array(s*2),t.cpos=0),t.cbuf[t.cpos++]=e},we=h,p=(t,e)=>{for(;e>w;)h(t,m|w&e),e=S(e/128);h(t,w&e)},j=(t,e)=>{const s=Q(e);for(s&&(e=-e),h(t,(e>B?m:0)|(s?Y:0)|B&e),e=S(e/64);e>0;)h(t,(e>w?m:0)|w&e),e=S(e/128)},V=new Uint8Array(3e4),xt=V.length/3,kt=(t,e)=>{if(e.length<xt){const s=D.encodeInto(e,V).written||0;p(t,s);for(let n=0;n<s;n++)h(t,V[n])}else st(t,Dt(e))},Ot=(t,e)=>{const s=unescape(encodeURIComponent(e)),n=s.length;p(t,n);for(let i=0;i<n;i++)h(t,s.codePointAt(i))},k=D&&D.encodeInto?kt:Ot,et=(t,e)=>{const s=t.cbuf.length,n=t.cpos,i=dt(s-n,e.length),o=e.length-i;t.cbuf.set(e.subarray(0,i),n),t.cpos+=i,o>0&&(t.bufs.push(t.cbuf),t.cbuf=new Uint8Array(K(s*2,o)),t.cbuf.set(e.subarray(i)),t.cpos=o)},st=(t,e)=>{p(t,e.byteLength),et(t,e)},z=(t,e)=>{Et(t,e);const s=new DataView(t.cbuf.buffer,t.cpos,e);return t.cpos+=e,s},Ct=(t,e)=>z(t,4).setFloat32(0,e,!1),Pt=(t,e)=>z(t,8).setFloat64(0,e,!1),Lt=(t,e)=>z(t,8).setBigInt64(0,e,!1),G=new DataView(new ArrayBuffer(4)),Rt=t=>(G.setFloat32(0,t),G.getFloat32(0)===t),J=(t,e)=>{switch(typeof e){case"string":h(t,119),k(t,e);break;case"number":bt(e)&&pt(e)<=yt?(h(t,125),j(t,e)):Rt(e)?(h(t,124),Ct(t,e)):(h(t,123),Pt(t,e));break;case"bigint":h(t,122),Lt(t,e);break;case"object":if(e===null)h(t,126);else if(ut(e)){h(t,117),p(t,e.length);for(let s=0;s<e.length;s++)J(t,e[s])}else if(e instanceof Uint8Array)h(t,116),st(t,e);else{h(t,118);const s=Object.keys(e);p(t,s.length);for(let n=0;n<s.length;n++){const i=s[n];k(t,i),J(t,e[i])}}break;case"boolean":h(t,e?120:121);break;default:h(t,127)}};class Se extends _{constructor(e){super(),this.w=e,this.s=null,this.count=0}write(e){this.s===e?this.count++:(this.count>0&&p(this,this.count-1),this.count=1,this.w(this,e),this.s=e)}}const W=t=>{t.count>0&&(j(t.encoder,t.count===1?t.s:-t.s),t.count>1&&p(t.encoder,t.count-2))};class Tt{constructor(){this.encoder=new _,this.s=0,this.count=0}write(e){this.s===e?this.count++:(W(this),this.count=1,this.s=e)}toUint8Array(){return W(this),L(this.encoder)}}const X=t=>{if(t.count>0){const e=t.diff*2+(t.count===1?0:1);j(t.encoder,e),t.count>1&&p(t.encoder,t.count-2)}};class me{constructor(){this.encoder=new _,this.s=0,this.count=0,this.diff=0}write(e){this.diff===e-this.s?(this.s=e,this.count++):(X(this),this.count=1,this.diff=e-this.s,this.s=e)}toUint8Array(){return X(this),L(this.encoder)}}class Ae{constructor(){this.sarr=[],this.s="",this.lensE=new Tt}write(e){this.s+=e,this.s.length>19&&(this.sarr.push(this.s),this.s=""),this.lensE.write(e.length)}toUint8Array(){const e=new _;return this.sarr.push(this.s),this.s="",k(e,this.sarr.join("")),et(e,this.lensE.toUint8Array()),L(e)}}const R=t=>new Error(t),Ue=()=>{throw R("Method unimplemented")},Ft=()=>{throw R("Unexpected case")},nt=R("Unexpected end of array"),it=R("Integer out of Range");class T{constructor(e){this.arr=e,this.pos=0}}const Nt=t=>new T(t),Bt=t=>t.pos!==t.arr.length,Vt=(t,e)=>{const s=new Uint8Array(t.arr.buffer,t.pos+t.arr.byteOffset,e);return t.pos+=e,s},ot=t=>Vt(t,d(t)),H=t=>t.arr[t.pos++],d=t=>{let e=0,s=1;const n=t.arr.length;for(;t.pos<n;){const i=t.arr[t.pos++];if(e=e+(i&w)*s,s*=128,i<m)return e;if(e>tt)throw it}throw nt},M=t=>{let e=t.arr[t.pos++],s=e&B,n=64;const i=(e&Y)>0?-1:1;if(!(e&m))return i*s;const o=t.arr.length;for(;t.pos<o;){if(e=t.arr[t.pos++],s=s+(e&w)*n,n*=128,e<m)return i*s;if(s>tt)throw it}throw nt},Ht=t=>{let e=d(t);if(e===0)return"";{let s=String.fromCodePoint(H(t));if(--e<100)for(;e--;)s+=String.fromCodePoint(H(t));else for(;e>0;){const n=e<1e4?e:1e4,i=t.arr.subarray(t.pos,t.pos+n);t.pos+=n,s+=String.fromCodePoint.apply(null,i),e-=n}return decodeURIComponent(escape(s))}},jt=t=>U.decode(ot(t)),O=U?jt:Ht,$=(t,e)=>{const s=new DataView(t.arr.buffer,t.arr.byteOffset+t.pos,e);return t.pos+=e,s},zt=t=>$(t,4).getFloat32(0,!1),Mt=t=>$(t,8).getFloat64(0,!1),$t=t=>$(t,8).getBigInt64(0,!1),qt=[t=>{},t=>null,M,zt,Mt,$t,t=>!1,t=>!0,O,t=>{const e=d(t),s={};for(let n=0;n<e;n++){const i=O(t);s[i]=Z(t)}return s},t=>{const e=d(t),s=[];for(let n=0;n<e;n++)s.push(Z(t));return s},ot],Z=t=>qt[127-H(t)](t);class Ie extends T{constructor(e,s){super(e),this.reader=s,this.s=null,this.count=0}read(){return this.count===0&&(this.s=this.reader(this),Bt(this)?this.count=d(this)+1:this.count=-1),this.count--,this.s}}class Gt extends T{constructor(e){super(e),this.s=0,this.count=0}read(){if(this.count===0){this.s=M(this);const e=Q(this.s);this.count=1,e&&(this.s=-this.s,this.count=d(this)+2)}return this.count--,this.s}}class De extends T{constructor(e){super(e),this.s=0,this.count=0,this.diff=0}read(){if(this.count===0){const e=M(this),s=e&1;this.diff=S(e/2),this.count=1,s&&(this.count=d(this)+2)}return this.s+=this.diff,this.count--,this.s}}class _e{constructor(e){this.decoder=new Gt(e),this.str=O(this.decoder),this.spos=0}read(){const e=this.spos+this.decoder.read(),s=this.str.slice(this.spos,e);return this.spos=e,s}}const C=Date.now,ve=Object.assign,Jt=Object.keys,Ee=(t,e)=>{for(const s in t)e(t[s],s)},P=t=>Jt(t).length,xe=t=>{for(const e in t)return!1;return!0},Wt=(t,e)=>{for(const s in t)if(!e(t[s],s))return!1;return!0},rt=(t,e)=>Object.prototype.hasOwnProperty.call(t,e),ke=(t,e)=>t===e||P(t)===P(e)&&Wt(t,(s,n)=>(s!==void 0||rt(e,n))&&e[n]===s),Xt=(t,e,s=0)=>{try{for(;s<t.length;s++)t[s](...e)}finally{s<t.length&&Xt(t,e,s+1)}},Oe=()=>{},Ce=t=>t,Zt=(t,e)=>t===e,I=(t,e)=>{if(t==null||e==null)return Zt(t,e);if(t.constructor!==e.constructor)return!1;if(t===e)return!0;switch(t.constructor){case ArrayBuffer:t=new Uint8Array(t),e=new Uint8Array(e);case Uint8Array:{if(t.byteLength!==e.byteLength)return!1;for(let s=0;s<t.length;s++)if(t[s]!==e[s])return!1;break}case Set:{if(t.size!==e.size)return!1;for(const s of t)if(!e.has(s))return!1;break}case Map:{if(t.size!==e.size)return!1;for(const s of t.keys())if(!e.has(s)||!I(t.get(s),e.get(s)))return!1;break}case Object:if(P(t)!==P(e))return!1;for(const s in t)if(!rt(t,s)||!I(t[s],e[s]))return!1;break;case Array:if(t.length!==e.length)return!1;for(let s=0;s<t.length;s++)if(!I(t[s],e[s]))return!1;break;default:return!1}return!0},Pe=(t,e)=>e.includes(t),Kt=()=>{let t=!0;return(e,s)=>{if(t){t=!1;try{e()}finally{t=!0}}else s!==void 0&&s()}},F=3e4;class Le extends gt{constructor(e){super(),this.doc=e,this.clientID=e.clientID,this.states=new Map,this.meta=new Map,this._checkInterval=setInterval(()=>{const s=C();this.getLocalState()!==null&&F/2<=s-this.meta.get(this.clientID).lastUpdated&&this.setLocalState(this.getLocalState());const n=[];this.meta.forEach((i,o)=>{o!==this.clientID&&F<=s-i.lastUpdated&&this.states.has(o)&&n.push(o)}),n.length>0&&Qt(this,n,"timeout")},S(F/10)),e.on("destroy",()=>{this.destroy()}),this.setLocalState({})}destroy(){this.emit("destroy",[this]),this.setLocalState(null),super.destroy(),clearInterval(this._checkInterval)}getLocalState(){return this.states.get(this.clientID)||null}setLocalState(e){const s=this.clientID,n=this.meta.get(s),i=n===void 0?0:n.clock+1,o=this.states.get(s);e===null?this.states.delete(s):this.states.set(s,e),this.meta.set(s,{clock:i,lastUpdated:C()});const r=[],a=[],c=[],l=[];e===null?l.push(s):o==null?e!=null&&r.push(s):(a.push(s),I(o,e)||c.push(s)),(r.length>0||c.length>0||l.length>0)&&this.emit("change",[{added:r,updated:c,removed:l},"local"]),this.emit("update",[{added:r,updated:a,removed:l},"local"])}setLocalStateField(e,s){const n=this.getLocalState();n!==null&&this.setLocalState({...n,[e]:s})}getStates(){return this.states}}const Qt=(t,e,s)=>{const n=[];for(let i=0;i<e.length;i++){const o=e[i];if(t.states.has(o)){if(t.states.delete(o),o===t.clientID){const r=t.meta.get(o);t.meta.set(o,{clock:r.clock+1,lastUpdated:C()})}n.push(o)}}n.length>0&&(t.emit("change",[{added:[],updated:[],removed:n},s]),t.emit("update",[{added:[],updated:[],removed:n},s]))},Re=(t,e,s=t.states)=>{const n=e.length,i=_t();p(i,n);for(let o=0;o<n;o++){const r=e[o],a=s.get(r)||null,c=t.meta.get(r).clock;p(i,r),p(i,c),k(i,JSON.stringify(a))}return L(i)},Te=(t,e,s)=>{const n=Nt(e),i=C(),o=[],r=[],a=[],c=[],l=d(n);for(let u=0;u<l;u++){const f=d(n);let y=d(n);const g=JSON.parse(O(n)),b=t.meta.get(f),A=t.states.get(f),q=b===void 0?0:b.clock;(q<y||q===y&&g===null&&t.states.has(f))&&(g===null?f===t.clientID&&t.getLocalState()!=null?y++:t.states.delete(f):t.states.set(f,g),t.meta.set(f,{clock:y,lastUpdated:i}),b===void 0&&g!==null?o.push(f):b!==void 0&&g===null?c.push(f):g!==null&&(I(g,A)||a.push(f),r.push(f)))}(o.length>0||a.length>0||c.length>0)&&t.emit("change",[{added:o,updated:a,removed:c},s]),(o.length>0||r.length>0||c.length>0)&&t.emit("update",[{added:o,updated:r,removed:c},s])};class Yt{constructor(e,s,n){this.start=e,this.end=s,this.direction=n}}const te=(t,e,s)=>{const n=t.getSelection();if(n!==null){const i=n.getStartPosition(),o=n.getEndPosition(),r=x(s,e.getOffsetAt(i)),a=x(s,e.getOffsetAt(o));return new Yt(r,a,n.getDirection())}return null},ee=(t,e,s,n)=>{const i=E(s.start,n),o=E(s.end,n);if(i!==null&&o!==null&&i.type===e&&o.type===e){const r=t.getModel(),a=r.getPositionAt(i.index),c=r.getPositionAt(o.index);return N.createWithDirection(a.lineNumber,a.column,c.lineNumber,c.column,s.direction)}return null};class Fe{constructor(e,s,n=new Set,i=null){this.doc=e.doc,this.ytext=e,this.monacoModel=s,this.editors=n,this.mux=Kt(),this._savedSelections=new Map,this._beforeTransaction=()=>{this.mux(()=>{this._savedSelections=new Map,n.forEach(o=>{if(o.getModel()===s){const r=te(o,s,e);r!==null&&this._savedSelections.set(o,r)}})})},this.doc.on("beforeAllTransactions",this._beforeTransaction),this._decorations=new Map,this._rerenderDecorations=()=>{n.forEach(o=>{if(i&&o.getModel()===s){const r=this._decorations.get(o)||[],a=[];i.getStates().forEach((c,l)=>{if(l!==this.doc.clientID&&c.selection!=null&&c.selection.anchor!=null&&c.selection.head!=null){const u=E(c.selection.anchor,this.doc),f=E(c.selection.head,this.doc);if(u!==null&&f!==null&&u.type===e&&f.type===e){let y,g,b,A;u.index<f.index?(y=s.getPositionAt(u.index),g=s.getPositionAt(f.index),b="yRemoteSelectionHead yRemoteSelectionHead-"+l,A=null):(y=s.getPositionAt(f.index),g=s.getPositionAt(u.index),b=null,A="yRemoteSelectionHead yRemoteSelectionHead-"+l),a.push({range:new ct(y.lineNumber,y.column,g.lineNumber,g.column),options:{className:"yRemoteSelection yRemoteSelection-"+l,afterContentClassName:b,beforeContentClassName:A}})}}}),this._decorations.set(o,o.deltaDecorations(r,a))}else this._decorations.delete(o)})},this._ytextObserver=o=>{this.mux(()=>{let r=0;o.delta.forEach(a=>{if(a.retain!==void 0)r+=a.retain;else if(a.insert!==void 0){const c=s.getPositionAt(r),l=new N(c.lineNumber,c.column,c.lineNumber,c.column),u=a.insert;s.applyEdits([{range:l,text:u}]),r+=u.length}else if(a.delete!==void 0){const c=s.getPositionAt(r),l=s.getPositionAt(r+a.delete),u=new N(c.lineNumber,c.column,l.lineNumber,l.column);s.applyEdits([{range:u,text:""}])}else throw Ft()}),this._savedSelections.forEach((a,c)=>{const l=ee(c,e,a,this.doc);l!==null&&c.setSelection(l)})}),this._rerenderDecorations()},e.observe(this._ytextObserver);{const o=e.toString();s.getValue()!==o&&s.setValue(o)}this._monacoChangeHandler=s.onDidChangeContent(o=>{this.mux(()=>{this.doc.transact(()=>{o.changes.sort((r,a)=>a.rangeOffset-r.rangeOffset).forEach(r=>{e.delete(r.rangeOffset,r.rangeLength),e.insert(r.rangeOffset,r.text)})},this)})}),this._monacoDisposeHandler=s.onWillDispose(()=>{this.destroy()}),i&&(n.forEach(o=>{o.onDidChangeCursorSelection(()=>{if(o.getModel()===s){const r=o.getSelection();if(r===null)return;let a=s.getOffsetAt(r.getStartPosition()),c=s.getOffsetAt(r.getEndPosition());if(r.getDirection()===at.RTL){const l=a;a=c,c=l}i.setLocalStateField("selection",{anchor:x(e,a),head:x(e,c)})}}),i.on("change",this._rerenderDecorations)}),this.awareness=i)}destroy(){this._monacoChangeHandler.dispose(),this._monacoDisposeHandler.dispose(),this.ytext.unobserve(this._ytextObserver),this.doc.off("beforeAllTransactions",this._beforeTransaction),this.awareness&&this.awareness.off("change",this._rerenderDecorations)}}export{Se as $,Le as A,Re as B,Qt as C,we as D,H as E,Te as F,ft as G,Ue as H,Ft as I,Xt as J,K,ce as L,ie as M,xe as N,gt as O,ve as P,Ee as Q,fe as R,ge as S,he as T,ue as U,de as V,m as W,Y as X,pe as Y,me as Z,Tt as _,ye as a,Ae as a0,et as a1,re as a2,pt as a3,ke as a4,ae as a5,De as a6,Gt as a7,Ie as a8,_e as a9,Ce as aa,Fe as ab,ht as b,v as c,dt as d,st as e,be as f,C as g,ot as h,Pe as i,Dt as j,O as k,le as l,oe as m,Oe as n,Z as o,k as p,J as q,d as r,lt as s,L as t,R as u,Nt as v,p as w,_t as x,S as y,Kt as z};
